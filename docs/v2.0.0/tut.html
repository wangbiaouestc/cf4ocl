<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>cf4ocl (C Framework for OpenCL): Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42378595-1', 'auto');
  ga('send', 'pageview');
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">cf4ocl (C Framework for OpenCL)
   &#160;<span id="projectnumber">v2.0.0+1.43478a0</span>
   </div>
   <div id="projectbrief">Object-oriented framework for developing and benchmarking OpenCL projects in C/C++</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('tut.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3>Introduction</h3>
<p>This tutorial is based on the <code>canon</code> example available in the examples folder. The goal is to add two vectors, <code>a</code> and <code>b</code>, as well as a constant <code>d</code>, and save the result in a third vector, <code>c</code>. The OpenCL kernel which performs this operation is given in the following code:</p>
<div class="fragment"><div class="line">__kernel <span class="keywordtype">void</span> sum(__global <span class="keyword">const</span> uint *a, __global <span class="keyword">const</span> uint *b,</div>
<div class="line">    __global uint * c, uint d, uint buf_size) {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get global ID. */</span></div>
<div class="line">    uint gid = get_global_id(0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Only perform sum if this workitem is within the size of the</span></div>
<div class="line"><span class="comment">     * vector. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (gid &lt; buf_size)</div>
<div class="line">        c[gid] = a[gid] + b[gid] + d;</div>
<div class="line">}</div>
</div><!-- fragment --><p>For the purpose of this tutorial, we'll assume the kernel code is in a file called <code>mysum.cl</code>, and the host code in <code>mysum.c</code>.</p>
<h3>Getting started</h3>
<p>The <em>cf4ocl</em> header should be included at the beggining of the <code>mysum.c</code> file:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
</div><!-- fragment --><p>The next step is to get an context with an OpenCL device where we can perform our computation. <em>cf4ocl</em> has several constructor functions for creating contexts with different types of devices, some very simple, some very flexible. For example, <a class="el" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289" title="Creates a context wrapper from a device selected by the user from a menu. ">ccl_context_new_from_menu()</a> lets the user select the OpenCL device if more than one is available in the system, and returns a context containing the selected device. Let's use it:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Code. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(NULL);</div>
</div><!-- fragment --><p>Where we pass <code>NULL</code> we could have passed an error management object, which we'll discuss in detail further ahead. Error-throwing <em>cf4ocl</em> signal errors in two ways: 1) using the return value; and, 2) populating the error management object. In this case, because we're not passing this object, we have to rely on the return value to check for errors. A <code>NULL</code> return value indicates an error in all <em>cf4ocl</em> constructors:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (ctx == NULL) exit(-1);</div>
</div><!-- fragment --><p>In <em>cf4ocl</em>, all objects created with <code>new</code> constructors must be release using the respective <code>destroy</code> destructors. For contexts, this is the <a class="el" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba" title="Decrements the reference count of the context wrapper object. ">ccl_context_destroy()</a> function:</p>
<div class="fragment"><div class="line"><span class="comment">/* Destroy context wrapper. */</span></div>
<div class="line"><a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
</div><!-- fragment --><p>We now have compilable, leak-free <em>cf4ocl</em> program, although it doesn't do very much yet:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Code. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Destroy context wrapper. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>We can compile the program with <code>gcc</code> (or <code>clang</code>), and run it:</p>
<div class="fragment"><div class="line">$ gcc `pkg-config --cflags cf4ocl2` mysum.c -o mysum `pkg-config --libs cf4ocl2`</div>
<div class="line">$ ./mysum</div>
</div><!-- fragment --><p>With Clang the command is the same, just replace <code>gcc</code> with <code>clang</code>.</p>
<h3>Host and device buffers</h3>
<p>The goal of the program is to sum two vectors and a constant. Let's declare two host vectors with some values, a third host vector which will hold the result, three device buffers and the constant.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define VECSIZE 8</span></div>
<div class="line"><span class="preprocessor">#define SUM_CONST 3</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//...</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line">    <a class="code" href="structccl__buffer.html">CCLBuffer</a> * a = NULL, * b = NULL, * c = NULL;</div>
<div class="line">    cl_uint vec_a[VECSIZE] = {0, 1, 2, 3, 4, 5, 6, 7};</div>
<div class="line">    cl_uint vec_b[VECSIZE] = {3, 2, 1, 0, 1, 2, 3, 4};</div>
<div class="line">    cl_uint vec_c[VECSIZE];</div>
<div class="line">    cl_uint d = SUM_CONST;</div>
</div><!-- fragment --><p>It's necessary to instantiate the device buffers, of which <code>a</code> and <code>b</code> will be initialized with the values in the respective host vectors:</p>
<div class="fragment"><div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Code. */</span></div>
<div class="line">ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(NULL);</div>
<div class="line"><span class="keywordflow">if</span> (ctx == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Instantiate and initialize device buffers. */</span></div>
<div class="line">a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (a == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (b == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">c = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_WRITE_ONLY,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (c == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line"><span class="comment">//...</span></div>
</div><!-- fragment --><p>Don't forget the destructors at the end:</p>
<div class="fragment"><div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line"><a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(c);</div>
<div class="line"><a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(b);</div>
<div class="line"><a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(a);</div>
<div class="line"><a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">return</span> 0;</div>
</div><!-- fragment --><p>The complete program so far, which can be compiled and executed. Still doesn't do anything useful, but we're getting close.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define VECSIZE 8</span></div>
<div class="line"><span class="preprocessor">#define SUM_CONST 3</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line">    <a class="code" href="structccl__buffer.html">CCLBuffer</a> * a = NULL, * b = NULL, * c = NULL;</div>
<div class="line">    cl_uint vec_a[VECSIZE] = {0, 1, 2, 3, 4, 5, 6, 7};</div>
<div class="line">    cl_uint vec_b[VECSIZE] = {3, 2, 1, 0, 1, 2, 3, 4};</div>
<div class="line">    cl_uint vec_c[VECSIZE];</div>
<div class="line">    cl_uint d = SUM_CONST;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create context with user selected device. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Instantiate and initialize device buffers. */</span></div>
<div class="line">    a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (a == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (b == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    c = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_WRITE_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (c == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(c);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(b);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(a);</div>
<div class="line">    <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h3>Creating the command queue</h3>
<p>The <a class="el" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773" title="Create a new on-host command queue wrapper object. ">ccl_queue_new()</a> constructor provides the simplest way to create a command queue. However, command queue creation requires a device. At this time, only the context has the memory address of the selected device. To get a pointer to the device, one can use the <a class="el" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7" title="Get CCLDevice wrapper at given index. ">ccl_context_get_device()</a> function:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line"><a class="code" href="structccl__device.html">CCLDevice</a>* dev = NULL;</div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Get the selected device. */</span></div>
<div class="line">dev = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7">ccl_context_get_device</a>(ctx, 0, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (dev == NULL) exit(-1);</div>
</div><!-- fragment --><p>There's no need to release the device object. It will be automatically released when the context is destroyed, in accordance to the <a class="el" href="index.html#ug_new_destroy">new/destroy</a> rule.</p>
<p>Now we can create the command queue. We don't require any special queue properties for now, so we pass <code>0</code> in the third argument:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line"><a class="code" href="structccl__device.html">CCLDevice</a>* dev = NULL;</div>
<div class="line"><a class="code" href="structccl__queue.html">CCLQueue</a>* queue = NULL;</div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Create a command queue. */</span></div>
<div class="line">queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, 0, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (queue == NULL) exit(-1);</div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa2059bbd0f34d0dbc2f618e57f283993">ccl_queue_destroy</a>(queue);</div>
</div><!-- fragment --><p>Both <a class="el" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7" title="Get CCLDevice wrapper at given index. ">ccl_context_get_device()</a> and <a class="el" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773" title="Create a new on-host command queue wrapper object. ">ccl_queue_new()</a> expect an error handling object as the last argument. By passing <code>NULL</code> we must rely on the return value of these functions in order to check for errors. Here's the complete program so far:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define VECSIZE 8</span></div>
<div class="line"><span class="preprocessor">#define SUM_CONST 3</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line">    <a class="code" href="structccl__device.html">CCLDevice</a> * dev = NULL;</div>
<div class="line">    <a class="code" href="structccl__queue.html">CCLQueue</a> * queue = NULL;</div>
<div class="line">    <a class="code" href="structccl__buffer.html">CCLBuffer</a> * a = NULL, * b = NULL, * c = NULL;</div>
<div class="line">    cl_uint vec_a[VECSIZE] = {0, 1, 2, 3, 4, 5, 6, 7};</div>
<div class="line">    cl_uint vec_b[VECSIZE] = {3, 2, 1, 0, 1, 2, 3, 4};</div>
<div class="line">    cl_uint vec_c[VECSIZE];</div>
<div class="line">    cl_uint d = SUM_CONST;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create context with user selected device. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the selected device. */</span></div>
<div class="line">    dev = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7">ccl_context_get_device</a>(ctx, 0, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (dev == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create a command queue. */</span></div>
<div class="line">    queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, 0, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (queue == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Instantiate and initialize device buffers. */</span></div>
<div class="line">    a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (a == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (b == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    c = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_WRITE_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (c == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(c);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(b);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(a);</div>
<div class="line">    <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa2059bbd0f34d0dbc2f618e57f283993">ccl_queue_destroy</a>(queue);</div>
<div class="line">    <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Compile it and run it. As expected, nothing special happens yet.</p>
<h3>Creating and building the program</h3>
<p><em>cf4ocl</em> provides several constructors for creating <a class="el" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html">program objects</a>. When a single OpenCL C kernel source file is involved, the most adequate constructor is <a class="el" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga9a9844b053aa5e871c5f3955844ac13a" title="Create a new program wrapper object from a source file. ">ccl_program_new_from_source_file()</a>:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><a class="code" href="structccl__program.html">CCLProgram</a>* prg = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><span class="comment">/* Create program. */</span></div>
<div class="line">prg = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga9a9844b053aa5e871c5f3955844ac13a">ccl_program_new_from_source_file</a>(ctx, <span class="stringliteral">&quot;mysum.cl&quot;</span>, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (prg == NULL) exit(-1);</div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line"><a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga3e96ea5591aaa0635ddfd24854845c4a">ccl_program_destroy</a>(prg);</div>
<div class="line"><span class="comment">//...</span></div>
</div><!-- fragment --><p>Building the program is just as easy. For this purpose, we use the <a class="el" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gab8f0b94bff812ddf51f3e2b47cde9705" title="Utility function which builds (compiles and links) a program executable from the program source or bi...">ccl_program_build()</a> function which returns <code>CL_TRUE</code> if the build is successful or <code>CL_FALSE</code> otherwise:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line">cl_bool status;</div>
<div class="line"></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><span class="comment">/* Build program. */</span></div>
<div class="line">status = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gab8f0b94bff812ddf51f3e2b47cde9705">ccl_program_build</a>(prg, NULL, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (!status) exit(-1);</div>
</div><!-- fragment --><p>Here's the current state of our program:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define VECSIZE 8</span></div>
<div class="line"><span class="preprocessor">#define SUM_CONST 3</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line">    <a class="code" href="structccl__device.html">CCLDevice</a> * dev = NULL;</div>
<div class="line">    <a class="code" href="structccl__queue.html">CCLQueue</a> * queue = NULL;</div>
<div class="line">    <a class="code" href="structccl__program.html">CCLProgram</a>* prg = NULL;</div>
<div class="line">    <a class="code" href="structccl__buffer.html">CCLBuffer</a> * a = NULL, * b = NULL, * c = NULL;</div>
<div class="line">    cl_uint vec_a[VECSIZE] = {0, 1, 2, 3, 4, 5, 6, 7};</div>
<div class="line">    cl_uint vec_b[VECSIZE] = {3, 2, 1, 0, 1, 2, 3, 4};</div>
<div class="line">    cl_uint vec_c[VECSIZE];</div>
<div class="line">    cl_uint d = SUM_CONST;</div>
<div class="line">    cl_bool status;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create context with user selected device. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the selected device. */</span></div>
<div class="line">    dev = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7">ccl_context_get_device</a>(ctx, 0, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (dev == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create a command queue. */</span></div>
<div class="line">    queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, 0, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (queue == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Instantiate and initialize device buffers. */</span></div>
<div class="line">    a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (a == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (b == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    c = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_WRITE_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (c == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create program. */</span></div>
<div class="line">    prg = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga9a9844b053aa5e871c5f3955844ac13a">ccl_program_new_from_source_file</a>(ctx, <span class="stringliteral">&quot;mysum.cl&quot;</span>, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (prg == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Build program. */</span></div>
<div class="line">    status = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gab8f0b94bff812ddf51f3e2b47cde9705">ccl_program_build</a>(prg, NULL, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!status) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga3e96ea5591aaa0635ddfd24854845c4a">ccl_program_destroy</a>(prg);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(c);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(b);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(a);</div>
<div class="line">    <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa2059bbd0f34d0dbc2f618e57f283993">ccl_queue_destroy</a>(queue);</div>
<div class="line">    <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Compile and run it. Don't forget to put the <code>mysum.cl</code> file containing the kernel source code in the same folder, otherwise the program will not be successfully created.</p>
<p><b>Pro tip:</b> To get the build log automatically printed to screen, set the <code>G_MESSAGES_DEBUG</code> environment variable to <code>cf4ocl2</code>. For example:</p>
<div class="fragment"><div class="line">$ G_MESSAGES_DEBUG=cf4ocl2 ./mysum</div>
</div><!-- fragment --><p>Add some junk to the kernel source code, run our program and check the build log.</p>
<h3>Setting kernel arguments and running the program</h3>
<p><em>cf4ocl</em> greatly simplifies the execution of OpenCL programs. Instead of creating a kernel with <a href="http://www.khronos.org/registry/cl/sdk/2.0/docs/man/xhtml/clCreateKernel.html">clCreateKernel()</a>, setting kernel arguments one-by-one with <a href="http://www.khronos.org/registry/cl/sdk/2.0/docs/man/xhtml/clSetKernelArg.html">clSetKernelArg()</a>, and finally executing the kernel with <a href="http://www.khronos.org/registry/cl/sdk/2.0/docs/man/xhtml/clEnqueueNDRangeKernel.html">clEnqueueNDRangeKernel()</a>, <em>cf4ocl</em> allows client code to do this using a single function:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><span class="keywordtype">size_t</span> gws = VECSIZE;</div>
<div class="line"><a class="code" href="structccl__event.html">CCLEvent</a>* evt = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><span class="comment">/* Set kernel arguments and run kernel. */</span></div>
<div class="line">evt = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gabdf0fff525612aeb22304560e4ea3bce">ccl_program_enqueue_kernel</a>(prg, <span class="stringliteral">&quot;sum&quot;</span>, queue, 1, &amp;gws,</div>
<div class="line">    NULL, NULL, NULL, a, b, c, <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(d, cl_uint),</div>
<div class="line">    <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(gws, cl_uint), NULL);</div>
<div class="line"><span class="keywordflow">if</span> (!evt) exit(-1);</div>
</div><!-- fragment --><p>Buffer, image and sampler objects can be passed directly as kernel arguments. Local and private variables are passed using the <a class="el" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#gac5e64c7fa6e474e6b49c3342581fbe92" title="Defines a local kernel argument, which allocates local memory within the kernel with the specified si...">ccl_arg_local()</a> and <a class="el" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b" title="Define a private kernel argument. ">ccl_arg_priv()</a> macros, respectively.</p>
<p>A local work size vector is expected as the 6th argument to <a class="el" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gabdf0fff525612aeb22304560e4ea3bce" title="Enqueues a program kernel function for execution on a device. ">ccl_program_enqueue_kernel()</a>. In this example, we pass <code>NULL</code>, which means that the local work size is to be automatically determined by the OpenCL implementation (as specified in the <a href="http://www.khronos.org/registry/cl/sdk/2.0/docs/man/xhtml/clEnqueueNDRangeKernel.html">clEnqueueNDRangeKernel()</a> documentation). Often we need more control over this value, because OpenCL implementations don't let us know what local work size was effectively used. It can be a bit of a chore to determine a local work size, especially when multiple dimensions are involved. Among other things, it's necessary to check kernel and device limits. The <a class="el" href="group___c_c_l___k_e_r_n_e_l___w_r_a_p_p_e_r.html#ga5ca9f518edca3fabffe30d5b6cfb7da1" title="Suggest appropriate local (and optionally global) work sizes for the given real work size...">ccl_kernel_suggest_worksizes()</a> is a very versatile function which can help in this regard.</p>
<p>While the <a class="el" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gabdf0fff525612aeb22304560e4ea3bce" title="Enqueues a program kernel function for execution on a device. ">ccl_program_enqueue_kernel()</a> simplifies executing a kernel (including setting its arguments), <em>cf4ocl</em> provides additional functions which allow client code to have finer control over this process.</p>
<h3>Checking results</h3>
<p>To check the results of the kernel execution, it's necessary to first read the <code>c</code> output buffer from the device:</p>
<div class="fragment"><div class="line"><span class="comment">/* Read the output buffer from the device. */</span></div>
<div class="line">evt = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga4399e6ec33872f78ece3e011f8e59ff6">ccl_buffer_enqueue_read</a>(c, queue, CL_TRUE, 0,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_c, NULL, NULL);</div>
<div class="line"><span class="keywordflow">if</span> (!evt) exit(-1);</div>
</div><!-- fragment --><p>Now we can check the results:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Check for errors. */</span></div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; VECSIZE; ++i) {</div>
<div class="line">    <span class="keywordflow">if</span> (vec_c[i] != vec_a[i] + vec_b[i] + c) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Unexpected results.\n&quot;</span>);</div>
<div class="line">        exit(-1);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="comment">/* No errors found. */</span></div>
<div class="line">printf(<span class="stringliteral">&quot;Results OK!\n&quot;</span>);</div>
</div><!-- fragment --><p>We now have a fully working OpenCL program, simplified with <em>cf4ocl</em>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define VECSIZE 8</span></div>
<div class="line"><span class="preprocessor">#define SUM_CONST 3</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line">    <a class="code" href="structccl__device.html">CCLDevice</a> * dev = NULL;</div>
<div class="line">    <a class="code" href="structccl__queue.html">CCLQueue</a> * queue = NULL;</div>
<div class="line">    <a class="code" href="structccl__program.html">CCLProgram</a> * prg = NULL;</div>
<div class="line">    <a class="code" href="structccl__buffer.html">CCLBuffer</a> * a = NULL, * b = NULL, * c = NULL;</div>
<div class="line">    cl_uint vec_a[VECSIZE] = {0, 1, 2, 3, 4, 5, 6, 7};</div>
<div class="line">    cl_uint vec_b[VECSIZE] = {3, 2, 1, 0, 1, 2, 3, 4};</div>
<div class="line">    cl_uint vec_c[VECSIZE];</div>
<div class="line">    cl_uint d = SUM_CONST;</div>
<div class="line">    <span class="keywordtype">size_t</span> gws = VECSIZE;</div>
<div class="line">    cl_bool status;</div>
<div class="line">    <a class="code" href="structccl__event.html">CCLEvent</a> * evt = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create context with user selected device. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the selected device. */</span></div>
<div class="line">    dev = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7">ccl_context_get_device</a>(ctx, 0, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (dev == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create a command queue. */</span></div>
<div class="line">    queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, 0, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (queue == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Instantiate and initialize device buffers. */</span></div>
<div class="line">    a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (a == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (b == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    c = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_WRITE_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (c == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create program. */</span></div>
<div class="line">    prg = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga9a9844b053aa5e871c5f3955844ac13a">ccl_program_new_from_source_file</a>(ctx, <span class="stringliteral">&quot;mysum.cl&quot;</span>, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (prg == NULL) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Build program. */</span></div>
<div class="line">    status = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gab8f0b94bff812ddf51f3e2b47cde9705">ccl_program_build</a>(prg, NULL, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!status) exit(-1);</div>
<div class="line"></div>
<div class="line">    evt = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gabdf0fff525612aeb22304560e4ea3bce">ccl_program_enqueue_kernel</a>(prg, <span class="stringliteral">&quot;sum&quot;</span>, queue, 1, NULL, &amp;gws,</div>
<div class="line">        NULL, NULL, NULL, a, b, c, <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(d, cl_uint),</div>
<div class="line">        <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(gws, cl_uint), NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!evt) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read the output buffer from the device. */</span></div>
<div class="line">    evt = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga4399e6ec33872f78ece3e011f8e59ff6">ccl_buffer_enqueue_read</a>(c, queue, CL_TRUE, 0,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_c, NULL, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!evt) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Some OpenCL implementations don&#39;t respect the blocking read,</span></div>
<div class="line"><span class="comment">     * so this guarantees that the read is effectively finished. */</span></div>
<div class="line">    status = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa3bf9b3903eb682132d5add8f269e34f">ccl_queue_finish</a>(queue, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (!status) exit(-1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check for errors. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; VECSIZE; ++i) {</div>
<div class="line">        <span class="keywordflow">if</span> (vec_c[i] != vec_a[i] + vec_b[i] + d) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Unexpected results.\n&quot;</span>);</div>
<div class="line">            exit(-1);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* No errors found. */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;Results OK!\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">   <span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga3e96ea5591aaa0635ddfd24854845c4a">ccl_program_destroy</a>(prg);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(c);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(b);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(a);</div>
<div class="line">    <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa2059bbd0f34d0dbc2f618e57f283993">ccl_queue_destroy</a>(queue);</div>
<div class="line">    <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h3>A better way to check for errors</h3>
<p>Our program may be correctly implemented, but a number of OpenCL errors can still occur. Checking the return values of <em>cf4ocl</em> functions allows us only to determine that something went wrong, not what went wrong. Fortunately, all error-throwing <em>cf4ocl</em> functions accept the memory location of <a href="https://developer.gnome.org/glib/stable/glib-Error-Reporting.html#GError">GError</a> error handling object, usually the last function argument. If given, this object will be populated with an error code and an error domain, as well as an error message, if an error occurs. In our program we're passing <code>NULL</code> where the <code>GError</code> object memory location was expected, so no information about errors is made available to the caller. To change the way we're handling errors, we must first declare a <code>GError</code> object, and initialize it to <code>NULL</code>:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line">GError * err = NULL;</div>
</div><!-- fragment --><p>Then, we should pass the memory location of this object to all <em>cf4ocl</em> error-throwing functions, e.g.:</p>
<div class="fragment"><div class="line"><span class="comment">/* Create context with user selected device. */</span></div>
<div class="line">ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(&amp;err);</div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Get the selected device. */</span></div>
<div class="line">dev = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7">ccl_context_get_device</a>(ctx, 0, &amp;err);</div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Create a command queue. */</span></div>
<div class="line">queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, 0, &amp;err);</div>
<div class="line"><span class="comment">//...</span></div>
</div><!-- fragment --><p>Now we can check this object after <em>cf4ocl</em> function calls. Let's create a small macro to do so:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define CHECK_ERROR(err) \</span></div>
<div class="line"><span class="preprocessor">    if (err != NULL) { fprintf(stderr, &quot;\n%s\n&quot;, err-&gt;message); exit(-1); }</span></div>
</div><!-- fragment --><p>We can also remove the <code>status</code> and <code>evt</code> variables, because we don't rely on them anymore for error checking. Here's the complete program, with more informative error checking:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define VECSIZE 8</span></div>
<div class="line"><span class="preprocessor">#define SUM_CONST 3</span></div>
<div class="line"><span class="preprocessor">#define CHECK_ERROR(err) \</span></div>
<div class="line"><span class="preprocessor">    if (err != NULL) { fprintf(stderr, &quot;\n%s\n&quot;, err-&gt;message); exit(-1); }</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line">    <a class="code" href="structccl__device.html">CCLDevice</a> * dev = NULL;</div>
<div class="line">    <a class="code" href="structccl__queue.html">CCLQueue</a> * queue = NULL;</div>
<div class="line">    <a class="code" href="structccl__program.html">CCLProgram</a> * prg = NULL;</div>
<div class="line">    <a class="code" href="structccl__buffer.html">CCLBuffer</a> * a = NULL, * b = NULL, * c = NULL;</div>
<div class="line">    cl_uint vec_a[VECSIZE] = {0, 1, 2, 3, 4, 5, 6, 7};</div>
<div class="line">    cl_uint vec_b[VECSIZE] = {3, 2, 1, 0, 1, 2, 3, 4};</div>
<div class="line">    cl_uint vec_c[VECSIZE];</div>
<div class="line">    cl_uint d = SUM_CONST;</div>
<div class="line">    <span class="keywordtype">size_t</span> gws = VECSIZE;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    GError * err = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create context with user selected device. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(&amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the selected device. */</span></div>
<div class="line">    dev = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7">ccl_context_get_device</a>(ctx, 0, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create a command queue. */</span></div>
<div class="line">    queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, 0, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Instantiate and initialize device buffers. */</span></div>
<div class="line">    a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY | CL_MEM_COPY_HOST_PTR,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    c = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_WRITE_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create program. */</span></div>
<div class="line">    prg = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga9a9844b053aa5e871c5f3955844ac13a">ccl_program_new_from_source_file</a>(ctx, <span class="stringliteral">&quot;mysum.cl&quot;</span>, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Build program. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gab8f0b94bff812ddf51f3e2b47cde9705">ccl_program_build</a>(prg, NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gabdf0fff525612aeb22304560e4ea3bce">ccl_program_enqueue_kernel</a>(prg, <span class="stringliteral">&quot;sum&quot;</span>, queue, 1, NULL, &amp;gws,</div>
<div class="line">        NULL, NULL, &amp;err, a, b, c, <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(d, cl_uint),</div>
<div class="line">        <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(gws, cl_uint), NULL);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read the output buffer from the device. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga4399e6ec33872f78ece3e011f8e59ff6">ccl_buffer_enqueue_read</a>(c, queue, CL_TRUE, 0,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_c, NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Some OpenCL implementations don&#39;t respect the blocking read,</span></div>
<div class="line"><span class="comment">     * so this guarantees that the read is effectively finished. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa3bf9b3903eb682132d5add8f269e34f">ccl_queue_finish</a>(queue, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check for errors. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; VECSIZE; ++i) {</div>
<div class="line">        <span class="keywordflow">if</span> (vec_c[i] != vec_a[i] + vec_b[i] + d) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Unexpected results.\n&quot;</span>);</div>
<div class="line">            exit(-1);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* No errors found. */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;Results OK!\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">   <span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga3e96ea5591aaa0635ddfd24854845c4a">ccl_program_destroy</a>(prg);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(c);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(b);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(a);</div>
<div class="line">    <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa2059bbd0f34d0dbc2f618e57f283993">ccl_queue_destroy</a>(queue);</div>
<div class="line">    <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The error checking strategy in our program is just an example. Client code can implement any strategy. More information about this topic is available in the <a class="el" href="index.html#ug_errorhandle">user guide</a>.</p>
<h3>Profiling your program the easy way</h3>
<p>Profiling OpenCL code by hand, i.e. by gathering and processing information about all <code>cl_event</code> objects, is an extremely verbose and error-prone process. However, it comes for free with <em>cf4ocl</em>. Well, mostly. The first change we must perform on our program is to enable profiling when the command queue is created:</p>
<div class="fragment"><div class="line"><span class="comment">/* Create a command queue. */</span></div>
<div class="line">queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, CL_QUEUE_PROFILING_ENABLE, &amp;err);</div>
</div><!-- fragment --><p>Additionally, we copied host vectors to device implicitly during device buffer creation. These implicit transfers don't produce OpenCL events, and are thus unavailable for profiling. As such, we must make these operations explicit:</p>
<div class="fragment"><div class="line"><span class="comment">/* Instantiate device buffers. */</span></div>
<div class="line">a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, &amp;err);</div>
<div class="line">CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, &amp;err);</div>
<div class="line">CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Initialize device buffers. */</span></div>
<div class="line"><a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga35233c6c927a2304d81ce149a2de673c">ccl_buffer_enqueue_write</a>(a, queue, CL_TRUE, 0,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, NULL, &amp;err);</div>
<div class="line">CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line"><a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga35233c6c927a2304d81ce149a2de673c">ccl_buffer_enqueue_write</a>(b, queue, CL_TRUE, 0,</div>
<div class="line">    VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, NULL, &amp;err);</div>
<div class="line">CHECK_ERROR(err);</div>
</div><!-- fragment --><p>We can now profile our program using functionality provided by the <a class="el" href="group___c_c_l___p_r_o_f_i_l_e_r.html">profiler module</a>:</p>
<div class="fragment"><div class="line"><span class="comment">/* Variables. */</span></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"><a class="code" href="structccl__prof.html">CCLProf</a>* prof = NULL;</div>
<div class="line"></div>
<div class="line"><span class="comment">//...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Perform profiling. */</span></div>
<div class="line">prof = <a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga6b5424a140676c5820dbd951c0fb282a">ccl_prof_new</a>();</div>
<div class="line"><a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga3920fcbeab72384c0f029933af53f4c0">ccl_prof_add_queue</a>(prof, <span class="stringliteral">&quot;queue1&quot;</span>, queue);</div>
<div class="line"><a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga5e75d3f7775d4d0844b55c373fb1f93c">ccl_prof_calc</a>(prof, &amp;err);</div>
<div class="line">CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Show profiling info. */</span></div>
<div class="line"><a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga97f32fd83cad28fbc1d079a7d18e2066">ccl_prof_print_summary</a>(prof);</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Destroy profiler object. */</span></div>
<div class="line"><a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga9b0453462582d7335c3cf09f9c2eae46">ccl_prof_destroy</a>(prof);</div>
</div><!-- fragment --><p>Our final program, with error checking and profiling, is as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cf4ocl2.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define VECSIZE 8</span></div>
<div class="line"><span class="preprocessor">#define SUM_CONST 3</span></div>
<div class="line"><span class="preprocessor">#define CHECK_ERROR(err) \</span></div>
<div class="line"><span class="preprocessor">    if (err != NULL) { fprintf(stderr, &quot;\n%s\n&quot;, err-&gt;message); exit(-1); }</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="test__buffer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Variables. */</span></div>
<div class="line">    <a class="code" href="structccl__context.html">CCLContext</a> * ctx = NULL;</div>
<div class="line">    <a class="code" href="structccl__device.html">CCLDevice</a> * dev = NULL;</div>
<div class="line">    <a class="code" href="structccl__queue.html">CCLQueue</a> * queue = NULL;</div>
<div class="line">    <a class="code" href="structccl__program.html">CCLProgram</a> * prg = NULL;</div>
<div class="line">    <a class="code" href="structccl__buffer.html">CCLBuffer</a> * a = NULL, * b = NULL, * c = NULL;</div>
<div class="line">    cl_uint vec_a[VECSIZE] = {0, 1, 2, 3, 4, 5, 6, 7};</div>
<div class="line">    cl_uint vec_b[VECSIZE] = {3, 2, 1, 0, 1, 2, 3, 4};</div>
<div class="line">    cl_uint vec_c[VECSIZE];</div>
<div class="line">    cl_uint d = SUM_CONST;</div>
<div class="line">    <span class="keywordtype">size_t</span> gws = VECSIZE;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    GError * err = NULL;</div>
<div class="line">    <a class="code" href="structccl__prof.html">CCLProf</a>* prof = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create context with user selected device. */</span></div>
<div class="line">    ctx = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga8e9832d88b1db2432c8694a64f911289">ccl_context_new_from_menu</a>(&amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get the selected device. */</span></div>
<div class="line">    dev = <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga7b425787d8bdd23e88ff4f8242ac94c7">ccl_context_get_device</a>(ctx, 0, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create a command queue. */</span></div>
<div class="line">    queue = <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#ga19d744607a66062c9c4073d483c19773">ccl_queue_new</a>(ctx, dev, CL_QUEUE_PROFILING_ENABLE, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Instantiate device buffers. */</span></div>
<div class="line">    a = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    b = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_READ_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    c = <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gaad3ceccbfd37a726e5deb8b088c21273">ccl_buffer_new</a>(ctx, CL_MEM_WRITE_ONLY,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize device buffers. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga35233c6c927a2304d81ce149a2de673c">ccl_buffer_enqueue_write</a>(a, queue, CL_TRUE, 0,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_a, NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga35233c6c927a2304d81ce149a2de673c">ccl_buffer_enqueue_write</a>(b, queue, CL_TRUE, 0,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_b, NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create program. */</span></div>
<div class="line">    prg = <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga9a9844b053aa5e871c5f3955844ac13a">ccl_program_new_from_source_file</a>(ctx, <span class="stringliteral">&quot;mysum.cl&quot;</span>, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Build program. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gab8f0b94bff812ddf51f3e2b47cde9705">ccl_program_build</a>(prg, NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#gabdf0fff525612aeb22304560e4ea3bce">ccl_program_enqueue_kernel</a>(prg, <span class="stringliteral">&quot;sum&quot;</span>, queue, 1, NULL, &amp;gws,</div>
<div class="line">        NULL, NULL, &amp;err, a, b, c, <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(d, cl_uint),</div>
<div class="line">        <a class="code" href="group___c_c_l___k_e_r_n_e_l___a_r_g.html#ga95f41500496777d0ea1e23aee566e90b">ccl_arg_priv</a>(gws, cl_uint), NULL);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Read the output buffer from the device. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#ga4399e6ec33872f78ece3e011f8e59ff6">ccl_buffer_enqueue_read</a>(c, queue, CL_TRUE, 0,</div>
<div class="line">        VECSIZE * <span class="keyword">sizeof</span>(cl_uint), vec_c, NULL, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Some OpenCL implementations don&#39;t respect the blocking read,</span></div>
<div class="line"><span class="comment">     * so this guarantees that the read is effectively finished. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa3bf9b3903eb682132d5add8f269e34f">ccl_queue_finish</a>(queue, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Check for errors. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; VECSIZE; ++i) {</div>
<div class="line">        <span class="keywordflow">if</span> (vec_c[i] != vec_a[i] + vec_b[i] + d) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Unexpected results.\n&quot;</span>);</div>
<div class="line">            exit(-1);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* No errors found. */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;Results OK!\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Perform profiling. */</span></div>
<div class="line">    prof = <a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga6b5424a140676c5820dbd951c0fb282a">ccl_prof_new</a>();</div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga3920fcbeab72384c0f029933af53f4c0">ccl_prof_add_queue</a>(prof, <span class="stringliteral">&quot;queue1&quot;</span>, queue);</div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga5e75d3f7775d4d0844b55c373fb1f93c">ccl_prof_calc</a>(prof, &amp;err);</div>
<div class="line">    CHECK_ERROR(err);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Show profiling info. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga97f32fd83cad28fbc1d079a7d18e2066">ccl_prof_print_summary</a>(prof);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Destroy profiler object. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_f_i_l_e_r.html#ga9b0453462582d7335c3cf09f9c2eae46">ccl_prof_destroy</a>(prof);</div>
<div class="line"></div>
<div class="line">   <span class="comment">/* Destroy cf4ocl wrappers. */</span></div>
<div class="line">    <a class="code" href="group___c_c_l___p_r_o_g_r_a_m___w_r_a_p_p_e_r.html#ga3e96ea5591aaa0635ddfd24854845c4a">ccl_program_destroy</a>(prg);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(c);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(b);</div>
<div class="line">    <a class="code" href="group___c_c_l___b_u_f_f_e_r___w_r_a_p_p_e_r.html#gae761eec2e3606f68832925a2ffc8f49b">ccl_buffer_destroy</a>(a);</div>
<div class="line">    <a class="code" href="group___c_c_l___q_u_e_u_e___w_r_a_p_p_e_r.html#gaa2059bbd0f34d0dbc2f618e57f283993">ccl_queue_destroy</a>(queue);</div>
<div class="line">    <a class="code" href="group___c_c_l___c_o_n_t_e_x_t___w_r_a_p_p_e_r.html#ga098e2247761d601377556cd26e1e28ba">ccl_context_destroy</a>(ctx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Compile and run the program. A profiling summary will be printed on the screen, something like:</p>
<pre class="fragment"> Aggregate times by event  :
   ------------------------------------------------------------------
   | Event name                     | Rel. time (%) | Abs. time (s) |
   ------------------------------------------------------------------
   | NDRANGE_KERNEL                 |       64.8583 |    1.7993e-05 |
   | WRITE_BUFFER                   |       31.8254 |    8.8290e-06 |
   | READ_BUFFER                    |        3.3163 |    9.2000e-07 |
   ------------------------------------------------------------------
                                    |         Total |    2.7742e-05 |
                                    ---------------------------------
 Event overlaps            : None</pre><p>While this profiling summary is useful, the <a class="el" href="group___c_c_l___p_r_o_f_i_l_e_r.html">profiler module</a> can do much more. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jan 13 2015 22:42:18 for cf4ocl (C Framework for OpenCL) by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.7 </li>
  </ul>
</div>
</body>
</html>
